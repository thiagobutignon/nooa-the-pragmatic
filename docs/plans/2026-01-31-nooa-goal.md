# nooa goal Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement Focus Guard — commands to set, track, and enforce current OKR/goal to prevent scope creep.

**Architecture:** Store current goal in `.nooa/GOAL.md`. Commands to set, status, and validate against.

**Tech Stack:** Bun, TypeScript, fs.

---

### Task 1: Goal Storage Schema

**Files:**
- Create: `src/features/goal/execute.ts`
- Test: `src/features/goal/execute.test.ts`

**Step 1: Write the failing test**

```typescript
import { expect, test, describe, beforeEach } from "bun:test";
import { setGoal, getGoal } from "./execute";
import { mkdir, rm } from "node:fs/promises";
import { join } from "node:path";
import { tmpdir } from "node:os";

describe("Goal Manager", () => {
    let testDir: string;

    beforeEach(async () => {
        testDir = join(tmpdir(), `nooa-goal-${Date.now()}`);
        await mkdir(join(testDir, ".nooa"), { recursive: true });
    });

    test("can set and get goal", async () => {
        await setGoal("Ship v1.0 by Friday", testDir);
        const goal = await getGoal(testDir);
        expect(goal).toContain("Ship v1.0 by Friday");
    });
});
```

**Step 2: Run test to verify it fails**

**Step 3: Write minimal implementation**

```typescript
// src/features/goal/execute.ts
import { readFile, writeFile } from "node:fs/promises";
import { join } from "node:path";
import { existsSync } from "node:fs";

export async function setGoal(goal: string, cwd: string = process.cwd()) {
    const path = join(cwd, ".nooa", "GOAL.md");
    const content = `# Current Goal\n\n${goal}\n\n---\nSet: ${new Date().toISOString()}`;
    await writeFile(path, content);
}

export async function getGoal(cwd: string = process.cwd()): Promise<string | null> {
    const path = join(cwd, ".nooa", "GOAL.md");
    if (!existsSync(path)) return null;
    return readFile(path, "utf-8");
}

export async function clearGoal(cwd: string = process.cwd()) {
    const path = join(cwd, ".nooa", "GOAL.md");
    if (existsSync(path)) {
        await writeFile(path, "# No active goal\n");
    }
}
```

**Step 4: Run test to verify it passes**

**Step 5: Commit**

```bash
git add src/features/goal/
git commit -m "feat: implement goal storage"
```

---

### Task 2: CLI Commands `nooa goal set/status/clear`

**Files:**
- Create: `src/features/goal/cli.ts`

**Step 1: Write the failing test**

```typescript
test("goal --help shows usage", async () => {
    const { stdout } = await execa("bun", ["index.ts", "goal", "--help"], { reject: false });
    expect(stdout).toContain("Usage: nooa goal");
});
```

**Step 2: Run test to verify it fails**

**Step 3: Write minimal implementation**

```typescript
// src/features/goal/cli.ts
import type { Command, CommandContext } from "../../core/command";
import { parseArgs } from "node:util";
import { setGoal, getGoal, clearGoal } from "./execute";

const goalHelp = `
Usage: nooa goal <subcommand> [flags]

Manage focus and prevent scope creep.

Subcommands:
  set <goal>     Set the current goal.
  status         Show current goal.
  clear          Clear the current goal.

Flags:
  --json         Output as JSON.
  -h, --help     Show help.
`;

const goalCommand: Command = {
    name: "goal",
    description: "Manage focus and goals",
    execute: async ({ rawArgs }: CommandContext) => {
        const { values, positionals } = parseArgs({
            args: rawArgs,
            options: { help: { type: "boolean", short: "h" }, json: { type: "boolean" } },
            allowPositionals: true, strict: false
        });
        if (values.help) { console.log(goalHelp); return; }

        const sub = positionals[1];

        if (sub === "set") {
            const goal = positionals.slice(2).join(" ");
            if (!goal) { console.error("Error: Goal text required"); process.exitCode = 2; return; }
            await setGoal(goal);
            console.log(`✅ Goal set: ${goal}`);
        } else if (sub === "status") {
            const goal = await getGoal();
            if (values.json) {
                console.log(JSON.stringify({ goal }));
            } else {
                console.log(goal || "No goal set. Use `nooa goal set <goal>`");
            }
        } else if (sub === "clear") {
            await clearGoal();
            console.log("✅ Goal cleared");
        } else {
            console.log(goalHelp);
        }
    }
};

export default goalCommand;
```

**Step 4: Run test to verify it passes**

**Step 5: Commit**

```bash
git add src/features/goal/
git commit -m "feat: add nooa goal command"
```

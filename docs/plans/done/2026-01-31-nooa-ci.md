# nooa ci Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Create a unified local CI pipeline that runs test + lint + check + coverage and outputs a structured report.

**Architecture:** Single command that orchestrates existing tools (bun test, biome, PolicyEngine) and aggregates results.

**Tech Stack:** Bun, TypeScript, execa.

---

### Task 1: CI Core Runner

**Files:**
- Create: `src/features/ci/execute.ts`
- Test: `src/features/ci/execute.test.ts`

**Step 1: Write the failing test**

```typescript
import { expect, test, describe } from "bun:test";
import { runCi } from "./execute";

describe("CI Runner", () => {
    test("returns structured result with all stages", async () => {
        const result = await runCi(process.cwd());
        expect(result).toHaveProperty("test");
        expect(result).toHaveProperty("lint");
        expect(result).toHaveProperty("check");
        expect(result).toHaveProperty("ok");
    });
});
```

**Step 2: Run test to verify it fails**

Run: `bun test src/features/ci/execute.test.ts`
Expected: FAIL (Cannot find module)

**Step 3: Write minimal implementation**

```typescript
// src/features/ci/execute.ts
import { execa } from "execa";
import { PolicyEngine } from "../../core/policy/PolicyEngine";

export interface CiResult {
    ok: boolean;
    test: { passed: boolean; exitCode: number };
    lint: { passed: boolean; exitCode: number };
    check: { passed: boolean; violations: number };
}

export async function runCi(cwd: string): Promise<CiResult> {
    const testResult = await execa("bun", ["test"], { cwd, reject: false });
    const lintResult = await execa("bun", ["run", "check"], { cwd, reject: false });
    
    const engine = new PolicyEngine(cwd);
    const { stdout } = await execa("git", ["ls-files"], { cwd });
    const files = stdout.split("\n").filter(f => f.endsWith(".ts"));
    const checkResult = await engine.checkFiles(files);

    return {
        ok: testResult.exitCode === 0 && lintResult.exitCode === 0 && checkResult.ok,
        test: { passed: testResult.exitCode === 0, exitCode: testResult.exitCode ?? 1 },
        lint: { passed: lintResult.exitCode === 0, exitCode: lintResult.exitCode ?? 1 },
        check: { passed: checkResult.ok, violations: checkResult.violations.length }
    };
}
```

**Step 4: Run test to verify it passes**

Run: `bun test src/features/ci/execute.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add src/features/ci/
git commit -m "feat: implement CI core runner"
```

---

### Task 2: CLI Command `nooa ci`

**Files:**
- Create: `src/features/ci/cli.ts`
- Test: `src/features/ci/cli.test.ts`

**Step 1: Write the failing test**

```typescript
import { expect, test, describe } from "bun:test";
import { execa } from "execa";

describe("ci cli", () => {
    test("--help shows usage", async () => {
        const { stdout, exitCode } = await execa("bun", ["index.ts", "ci", "--help"], { reject: false });
        expect(exitCode).toBe(0);
        expect(stdout).toContain("Usage: nooa ci");
    });
});
```

**Step 2: Run test to verify it fails**

Run: `bun test src/features/ci/cli.test.ts`
Expected: FAIL (Unknown subcommand)

**Step 3: Write minimal implementation**

```typescript
// src/features/ci/cli.ts
import type { Command, CommandContext } from "../../core/command";
import { parseArgs } from "node:util";
import { runCi } from "./execute";

const ciHelp = `
Usage: nooa ci [flags]

Run local CI pipeline (test + lint + check).

Flags:
  --json         Output results as JSON.
  -h, --help     Show help message.
`;

const ciCommand: Command = {
    name: "ci",
    description: "Run local CI pipeline",
    execute: async ({ rawArgs }: CommandContext) => {
        const { values } = parseArgs({
            args: rawArgs,
            options: { help: { type: "boolean", short: "h" }, json: { type: "boolean" } },
            allowPositionals: true,
            strict: false
        });

        if (values.help) { console.log(ciHelp); return; }

        const result = await runCi(process.cwd());
        
        if (values.json) {
            console.log(JSON.stringify(result, null, 2));
        } else {
            console.log(result.test.passed ? "✅ Tests passed" : "❌ Tests failed");
            console.log(result.lint.passed ? "✅ Lint passed" : "❌ Lint failed");
            console.log(result.check.passed ? "✅ Policy check passed" : `❌ Policy violations: ${result.check.violations}`);
            console.log(result.ok ? "\n✅ CI passed" : "\n❌ CI failed");
        }
        process.exitCode = result.ok ? 0 : 1;
    }
};

export default ciCommand;
```

**Step 4: Run test to verify it passes**

Run: `bun test src/features/ci/cli.test.ts`
Expected: PASS

**Step 5: Commit**

```bash
git add src/features/ci/
git commit -m "feat: add nooa ci command"
```

# Dogfooding Report: Command Pipeline (Run)

**Date**: 2026-01-30
**Environment**: `.worktrees/feat-run-refinement`

## Test Cases

### 1. Mixed Internal/External Pipeline (Success)
**Command**: `nooa run -- exec echo "Start" -- read README.md -- exec echo "End"`
**Expectation**: "Start", followed by README content, then "End".
**Result**: **PASS** (after fixing `rawArgs` dispatch bug).
**Notes**: Initially failed because `read` expected `rawArgs` to include "read" at index 0. Fixed `executor.ts` to pass full `argv`.

### 2. Failure Handling & JSON (Fail-Fast)
**Command**: `nooa run --json -- exec ls non_existent_file -- commit -m "should not run"`
**Expectation**: JSON output with `ok: false`, `failedStepIndex: 0`, and error details.
**Result**: **PASS**.
**Output Snippet**:
```json
{
  "schemaVersion": "1.0",
  "runId": "...",
  "ok": false,
  "failedStepIndex": 0,
  "steps": [
    {
      "step": { "kind": "external", "argv": ["ls", "non_existent_file"], ... },
      "exitCode": 1,
      "error": "Command failed with exit code 1: ls non_existent_file",
      ...
    }
  ]
}
```

### 3. Dry-Run Mode
**Command**: `nooa run --dry-run -- code write test.ts -- commit -m "test"`
**Expectation**: JSON plan showing the parsed steps without execution.
**Result**: **PASS**.

## Identified Issues (Fixed)
1. **Missing Dependencies**: `shell-quote` was missing in the new worktree. Added `bun install` step to `using-git-worktrees` skill and README instructions.
2. **Internal Dispatch Arguments**: Subcommands rely on `rawArgs[0]` being the command name. Updated `executor.ts` to maintain this convention.
3. **Implicit Registration Failure**: If a command fails to load (due to missing dependencies), it disappears from `--help` silently. Added help verification step to `create-cli` skill.

## Improvements Needed
- [ ] Add `--capture-output` flag for more granular JSON reports.
- [ ] Support `\--` escaping for literal delimiter arguments.

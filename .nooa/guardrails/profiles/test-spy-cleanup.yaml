# NOOA Guardrail: Test Spy Cleanup
# Ensures all spyOn calls have corresponding mockRestore() to prevent test pollution

refactor_name: test-spy-cleanup
description: Prevents test pollution by detecting spyOn without mockRestore
version: "1.0.0"

rules:
  - id: spyon-without-restore
    description: Every spyOn() call must have a corresponding mockRestore()
    severity: high
    category: test-quality
    match:
      anyOf:
        # Match standalone spyOn calls (not assigned to variable)
        - type: regex
          value: "^\\s*spyOn\\("
          flags: "m"
    scope:
      include:
        - "**/*.test.ts"
        - "**/*.spec.ts"
      exclude:
        - "**/node_modules/**"
        - "**/.nooa/**"

  - id: spy-variable-without-restore
    description: Spy variables must call mockRestore() before test ends
    severity: high  
    category: test-quality
    match:
      anyOf:
        # Match: const xxx = spyOn(...) but NO xxx.mockRestore() in same file
        - type: regex
          value: "const\\s+\\w+\\s*=\\s*spyOn\\("
          flags: "m"
    scope:
      include:
        - "**/*.test.ts"
        - "**/*.spec.ts"
      exclude:
        - "**/node_modules/**"
        - "**/.nooa/**"
